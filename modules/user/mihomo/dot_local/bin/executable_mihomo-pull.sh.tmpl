#!/bin/bash
# -*- mode: sh; -*-
# @option -i --id='{{ (rbwFields "sub-store").ID_ALL.value }}'
# @option -p --port='{{ .services.proxy.port }}'
# @meta require-tool mihomo
set -o errexit
set -o nounset
set -o pipefail

function main() {
  local id="${argc_id:?}"
  local port="${argc_port:?}"
  export port
  tmpfile="$(mktemp --suffix='.yaml')"
  trap 'rm --force "$tmpfile"' EXIT
  xhs --output "$tmpfile" --download GET \
    'https://sub.liblaf.me/subscribe/mihomo.yaml' id=="$id"
  yq eval '.mixed-port=env(port)' "$tmpfile" --inplace
  mihomo -f "$tmpfile" -t # test configuration
  sudo install -D --mode='u=rw,go=r' --no-target-directory --verbose "$tmpfile" '/etc/mihomo/config.yaml'
  sudo systemctl enable --now mihomo.service
  sudo systemctl restart mihomo.service
}

eval "$(argc --argc-eval "$0" "$@")"
