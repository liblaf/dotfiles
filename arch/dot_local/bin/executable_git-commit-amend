#!/usr/bin/python
import re
import subprocess
import sys
from re import Match, Pattern
from subprocess import CompletedProcess
from typing import cast

subprocess.run(
    args=["git", "diff", "--quiet", "--cached"],
    stdout=sys.stdout,
    stderr=sys.stderr,
    check=True,
)
process: CompletedProcess = subprocess.run(
    args=["git", "log", "--max-count=1", "--pretty=format:%B"],
    capture_output=True,
    check=True,
    text=True,
)
stdout: str = process.stdout
message: list[str] = stdout.splitlines()
pattern: Pattern = re.compile(
    pattern=r"(?P<type>\w+)(?P<scope>\(.+\))?(?P<breaking>!)?: (?P<subject>.+)"
)
match: Match[str] = cast(Match[str], pattern.fullmatch(string=message[0]))
type_: str = match.group("type").lower()
scope: str = (match.group("scope") or "").lower()
breaking: str = match.group("breaking") or ""
subject: str = match.group("subject")
subject = subject[0].lower() + subject[1:]
message[0] = type_ + scope + breaking + ": " + subject
subprocess.run(
    args=["git", "commit", "--file=-", "--amend"],
    stdout=sys.stdout,
    stderr=sys.stderr,
    check=True,
    input="\n".join(message),
    text=True,
)
