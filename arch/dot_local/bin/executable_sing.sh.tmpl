#!/bin/bash
set -o errexit -o nounset -o pipefail

function parser_definition() {
  setup REST help:usage -- "Usage: $0 [options]... [arguments]..." ''
  msg -- 'Options:'
  param ID --id init:='{{(rbwFields "Telegram").chat_id.value}}'
  param PORT -p --port
  disp :usage --help
}

eval "$(getoptions parser_definition) exit 1"

tmp=$(mktemp --suffix=".json")
trap 'rm --force "$tmp"' EXIT
if [[ -z $PORT ]]; then
  PORT=$(gsettings get org.gnome.system.proxy.https port)
elif ((PORT == 0)); then
  PORT='{{.port.proxy}}'
fi
https --download --output "$tmp" --verify no "https://api.liblaf.me/sub/$ID/sing-box" in.mixed.port=="$PORT" preset==linux
prettier --write "$tmp"
sudo install -D --mode="u=rw,go=r" --no-target-directory --verbose "$tmp" /etc/sing-box/config.json
sudo systemctl restart sing-box.service
