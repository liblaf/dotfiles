#!/bin/bash
set -o errexit
set -o nounset
set -o pipefail

ID='{{(bitwardenFields "item" "Telegram").chat_id.value}}'

tmp=$(mktemp --suffix=".json")
trap 'rm --force "$tmp"' EXIT
port=$(gsettings get org.gnome.system.proxy.https port)
if ((port == 0)); then
  port='{{.port.proxy}}'
fi
https --download --output "$tmp" --verify no "https://api.liblaf.me/sub/$ID/sing-box" in.mixed.port=="$port" preset==linux
prettier --write "$tmp"
sudo install -D --mode="u=rw,go=r" --no-target-directory --verbose "$tmp" /etc/sing-box/config.json
sudo systemctl restart sing-box.service
